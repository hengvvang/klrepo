# Linux å†…æ ¸ä¸åº•å±‚æŠ€æœ¯

## ğŸ”¬ æ¨¡å—æ¦‚è¿°

Linuxå†…æ ¸æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç†è§£å†…æ ¸æœºåˆ¶å¯¹äºç³»ç»Ÿç®¡ç†å‘˜ã€é©±åŠ¨å¼€å‘è€…å’Œæ€§èƒ½è°ƒä¼˜ä¸“å®¶è‡³å…³é‡è¦ã€‚æœ¬æ¨¡å—æ·±å…¥æ¢è®¨å†…æ ¸æ¶æ„ã€ç³»ç»Ÿè°ƒç”¨ã€è®¾å¤‡é©±åŠ¨ç­‰åº•å±‚æŠ€æœ¯ã€‚

## ğŸ“š æ ¸å¿ƒå†…å®¹

### ğŸ—ï¸ [å†…æ ¸æ¶æ„](kernel-architecture.md)
- **å†…æ ¸ç»“æ„** - å•ä½“å†…æ ¸æ¶æ„å’Œå­ç³»ç»Ÿç»„ç»‡
- **å†…å­˜ç®¡ç†** - è™šæ‹Ÿå†…å­˜ã€åˆ†é¡µæœºåˆ¶ã€å†…å­˜åˆ†é…
- **è¿›ç¨‹è°ƒåº¦** - CFSè°ƒåº¦å™¨ã€å®æ—¶è°ƒåº¦ã€è´Ÿè½½å‡è¡¡
- **ä¸­æ–­å¤„ç†** - ä¸­æ–­æœºåˆ¶ã€è½¯ä¸­æ–­ã€å·¥ä½œé˜Ÿåˆ—

### ğŸ“ [ç³»ç»Ÿè°ƒç”¨](system-calls.md)
- **ç³»ç»Ÿè°ƒç”¨æ¥å£** - ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´äº¤äº’
- **ç³»ç»Ÿè°ƒç”¨è¡¨** - ç³»ç»Ÿè°ƒç”¨å·å’Œå¤„ç†å‡½æ•°æ˜ å°„
- **å‚æ•°ä¼ é€’** - ç³»ç»Ÿè°ƒç”¨å‚æ•°å’Œè¿”å›å€¼æœºåˆ¶
- **æ€§èƒ½åˆ†æ** - ç³»ç»Ÿè°ƒç”¨æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### ğŸ”Œ [è®¾å¤‡é©±åŠ¨å¼€å‘](device-drivers.md)
- **é©±åŠ¨æ¡†æ¶** - Linuxè®¾å¤‡é©±åŠ¨æ¨¡å‹
- **å­—ç¬¦è®¾å¤‡é©±åŠ¨** - ç®€å•å­—ç¬¦è®¾å¤‡é©±åŠ¨å¼€å‘
- **å—è®¾å¤‡é©±åŠ¨** - å­˜å‚¨è®¾å¤‡é©±åŠ¨å¼€å‘
- **ç½‘ç»œè®¾å¤‡é©±åŠ¨** - ç½‘å¡é©±åŠ¨å¼€å‘åŸºç¡€

### ğŸ§© [å†…æ ¸æ¨¡å—](kernel-modules.md)
- **æ¨¡å—æœºåˆ¶** - å¯åŠ è½½å†…æ ¸æ¨¡å—(LKM)
- **æ¨¡å—å¼€å‘** - å†…æ ¸æ¨¡å—ç¼–å†™å’Œç¼–è¯‘
- **ç¬¦å·å¯¼å‡º** - æ¨¡å—é—´ç¬¦å·å…±äº«
- **æ¨¡å—å‚æ•°** - è¿è¡Œæ—¶å‚æ•°é…ç½®

### ğŸ” [å†…æ ¸è°ƒè¯•](kernel-debugging.md)
- **è°ƒè¯•æŠ€æœ¯** - KGDBã€crashå·¥å…·ä½¿ç”¨
- **å†…æ ¸æ—¥å¿—** - printkã€ftraceè·Ÿè¸ªç³»ç»Ÿ
- **å†…å­˜è°ƒè¯•** - KASANã€SLUBè°ƒè¯•
- **æ€§èƒ½åˆ†æ** - perfã€eBPFç¨‹åºå¼€å‘

### âš¡ [æ€§èƒ½ä¼˜åŒ–](kernel-optimization.md)
- **å†…æ ¸å‚æ•°è°ƒä¼˜** - sysctlå‚æ•°ä¼˜åŒ–
- **å†…å­˜ä¼˜åŒ–** - å¤§é¡µå†…å­˜ã€NUMAä¼˜åŒ–
- **I/Oä¼˜åŒ–** - è°ƒåº¦å™¨é€‰æ‹©ã€é˜Ÿåˆ—æ·±åº¦è°ƒä¼˜
- **ç½‘ç»œä¼˜åŒ–** - ç½‘ç»œæ ˆæ€§èƒ½ä¼˜åŒ–

## ğŸ—ï¸ Linuxå†…æ ¸æ¶æ„å›¾

### å†…æ ¸å­ç³»ç»Ÿ
```mermaid
graph TB
    A[ç”¨æˆ·ç©ºé—´åº”ç”¨] --> B[ç³»ç»Ÿè°ƒç”¨æ¥å£]
    B --> C[è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS]
    B --> D[ç½‘ç»œå­ç³»ç»Ÿ]
    B --> E[å†…å­˜ç®¡ç†]
    B --> F[è¿›ç¨‹ç®¡ç†]
    
    C --> G[æ–‡ä»¶ç³»ç»Ÿ]
    D --> H[åè®®æ ˆ]
    E --> I[é¡µé¢åˆ†é…å™¨]
    F --> J[è°ƒåº¦å™¨]
    
    G --> K[è®¾å¤‡é©±åŠ¨]
    H --> K
    I --> L[ç¡¬ä»¶æŠ½è±¡å±‚]
    J --> L
    K --> L
    
    L --> M[ç¡¬ä»¶å¹³å°]
```

### å†…æ ¸ç©ºé—´å¸ƒå±€
```bash
# æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬å’Œæ¶æ„
uname -a

# æŸ¥çœ‹å†…æ ¸é…ç½®
zcat /proc/config.gz | grep -E "CONFIG_.*=y" | head -20

# æŸ¥çœ‹å†…æ ¸æ¨¡å—
lsmod | head -10

# æŸ¥çœ‹å†…æ ¸ç¬¦å·è¡¨
cat /proc/kallsyms | head -10

# æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨è¡¨
cat /proc/sys/kernel/ostype
cat /proc/sys/kernel/osrelease
```

## ğŸ”§ å†…æ ¸å¼€å‘å·¥å…·

### å†…æ ¸æ„å»ºå·¥å…·
```bash
# å†…æ ¸æºç è·å–
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.tar.xz
tar xf linux-6.1.tar.xz
cd linux-6.1

# é…ç½®å†…æ ¸
make menuconfig      # å›¾å½¢åŒ–é…ç½®
make defconfig       # é»˜è®¤é…ç½®
make localmodconfig  # åŸºäºå½“å‰æ¨¡å—é…ç½®

# ç¼–è¯‘å†…æ ¸
make -j$(nproc)      # ç¼–è¯‘å†…æ ¸
make modules         # ç¼–è¯‘æ¨¡å—
make modules_install # å®‰è£…æ¨¡å—
make install         # å®‰è£…å†…æ ¸
```

### è°ƒè¯•å·¥å…·
```bash
# å†…æ ¸æ—¥å¿—æŸ¥çœ‹
dmesg | tail -20     # å†…æ ¸æ¶ˆæ¯
journalctl -k        # systemdå†…æ ¸æ—¥å¿—

# å†…æ ¸è·Ÿè¸ª
cd /sys/kernel/debug/tracing
echo function > current_tracer
echo 1 > tracing_on
cat trace | head -20

# æ€§èƒ½åˆ†æ
perf list            # å¯ç”¨äº‹ä»¶
perf record -g sleep 5  # è®°å½•æ€§èƒ½æ•°æ®
perf report          # åˆ†ææ€§èƒ½æ•°æ®
```

### æ¨¡å—å¼€å‘å·¥å…·
```bash
# æ¨¡å—ä¿¡æ¯æŸ¥çœ‹
modinfo ext4         # æ¨¡å—ä¿¡æ¯
modprobe -l | grep usb  # å¯ç”¨æ¨¡å—

# æ¨¡å—æ“ä½œ
insmod module.ko     # æ’å…¥æ¨¡å—
rmmod module         # ç§»é™¤æ¨¡å—
modprobe module      # æ™ºèƒ½æ¨¡å—åŠ è½½
```

## ğŸ“‹ å†…æ ¸å¼€å‘æ¸…å•

### å¼€å‘ç¯å¢ƒå‡†å¤‡
- [ ] å®‰è£…å†…æ ¸å¼€å‘åŒ…å’Œå¤´æ–‡ä»¶
- [ ] é…ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å‡†å¤‡è™šæ‹Ÿæœºæµ‹è¯•ç¯å¢ƒ
- [ ] å®‰è£…è°ƒè¯•å’Œåˆ†æå·¥å…·
- [ ] é…ç½®ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
- [ ] å‡†å¤‡æ–‡æ¡£å’Œå‚è€ƒèµ„æ–™
- [ ] è®¾ç½®æŒç»­é›†æˆç¯å¢ƒ
- [ ] é…ç½®é™æ€åˆ†æå·¥å…·

### æ¨¡å—å¼€å‘æµç¨‹
- [ ] éœ€æ±‚åˆ†æå’Œè®¾è®¡è§„åˆ’
- [ ] åˆ›å»ºåŸºç¡€æ¨¡å—æ¡†æ¶
- [ ] å®ç°æ ¸å¿ƒåŠŸèƒ½ä»£ç 
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] è¿›è¡Œä»£ç å®¡æŸ¥
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] æ–‡æ¡£ç¼–å†™å’Œç»´æŠ¤

## ğŸ¯ å®è·µé¡¹ç›®

### 1. ç®€å•å­—ç¬¦è®¾å¤‡é©±åŠ¨
```c
// hello.c - ç®€å•å†…æ ¸æ¨¡å—ç¤ºä¾‹
#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>

static int __init hello_init(void)
{
    printk(KERN_INFO "Hello, Linux Kernel!\n");
    return 0;
}

static void __exit hello_exit(void)
{
    printk(KERN_INFO "Goodbye, Linux Kernel!\n");
}

module_init(hello_init);
module_exit(hello_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("A simple hello world kernel module");
MODULE_VERSION("1.0");
```

```makefile
# Makefile
obj-m := hello.o

KERNELDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

default:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules

clean:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) clean

install:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install

.PHONY: default clean install
```

### 2. procæ–‡ä»¶ç³»ç»Ÿæ¥å£
```c
// proc_example.c - procæ–‡ä»¶ç³»ç»Ÿç¤ºä¾‹
#include <linux/init.h>
#include <linux/module.h>
#include <linux/proc_fs.h>
#include <linux/uaccess.h>

#define PROC_NAME "hello_proc"
#define BUFFER_SIZE 1024

static struct proc_dir_entry *proc_entry;
static char proc_buffer[BUFFER_SIZE];
static unsigned long proc_buffer_size = 0;

static ssize_t proc_read(struct file *file, char __user *buffer, 
                        size_t count, loff_t *pos)
{
    if (*pos > 0 || count < proc_buffer_size)
        return 0;
    
    if (copy_to_user(buffer, proc_buffer, proc_buffer_size))
        return -EFAULT;
    
    *pos = proc_buffer_size;
    return proc_buffer_size;
}

static ssize_t proc_write(struct file *file, const char __user *buffer,
                         size_t count, loff_t *pos)
{
    if (count > BUFFER_SIZE - 1)
        count = BUFFER_SIZE - 1;
    
    if (copy_from_user(proc_buffer, buffer, count))
        return -EFAULT;
    
    proc_buffer[count] = '\0';
    proc_buffer_size = count;
    return count;
}

static const struct proc_ops proc_fops = {
    .proc_read = proc_read,
    .proc_write = proc_write,
};

static int __init proc_init(void)
{
    proc_entry = proc_create(PROC_NAME, 0666, NULL, &proc_fops);
    if (proc_entry == NULL) {
        printk(KERN_ERR "Failed to create proc entry\n");
        return -ENOMEM;
    }
    
    strcpy(proc_buffer, "Hello from kernel!\n");
    proc_buffer_size = strlen(proc_buffer);
    
    printk(KERN_INFO "Proc module loaded\n");
    return 0;
}

static void __exit proc_exit(void)
{
    proc_remove(proc_entry);
    printk(KERN_INFO "Proc module unloaded\n");
}

module_init(proc_init);
module_exit(proc_exit);
MODULE_LICENSE("GPL");
```

### 3. ç®€å•çš„ç½‘ç»œè¿‡æ»¤å™¨
```c
// netfilter_example.c - ç½‘ç»œè¿‡æ»¤å™¨ç¤ºä¾‹
#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/netfilter.h>
#include <linux/netfilter_ipv4.h>
#include <linux/ip.h>
#include <linux/tcp.h>

static struct nf_hook_ops nfho;

static unsigned int hook_func(void *priv,
                             struct sk_buff *skb,
                             const struct nf_hook_state *state)
{
    struct iphdr *iph;
    struct tcphdr *tcph;
    
    if (!skb)
        return NF_ACCEPT;
    
    iph = ip_hdr(skb);
    if (iph->protocol == IPPROTO_TCP) {
        tcph = tcp_hdr(skb);
        
        // é˜»æ­¢åˆ°ç«¯å£80çš„è¿æ¥
        if (ntohs(tcph->dest) == 80) {
            printk(KERN_INFO "Blocking HTTP traffic to %pI4\n", 
                   &iph->daddr);
            return NF_DROP;
        }
    }
    
    return NF_ACCEPT;
}

static int __init netfilter_init(void)
{
    nfho.hook = hook_func;
    nfho.hooknum = NF_INET_PRE_ROUTING;
    nfho.pf = PF_INET;
    nfho.priority = NF_IP_PRI_FIRST;
    
    nf_register_net_hook(&init_net, &nfho);
    printk(KERN_INFO "Netfilter module loaded\n");
    return 0;
}

static void __exit netfilter_exit(void)
{
    nf_unregister_net_hook(&init_net, &nfho);
    printk(KERN_INFO "Netfilter module unloaded\n");
}

module_init(netfilter_init);
module_exit(netfilter_exit);
MODULE_LICENSE("GPL");
```

## ğŸ“Š å†…æ ¸æ€§èƒ½åˆ†æ

### å…³é”®æ€§èƒ½æŒ‡æ ‡
```bash
# CPUè°ƒåº¦å»¶è¿Ÿ
perf sched record sleep 10
perf sched latency

# å†…å­˜åˆ†é…è·Ÿè¸ª
echo 1 > /proc/sys/vm/drop_caches
perf record -e kmem:* sleep 5
perf report

# I/Oæ€§èƒ½åˆ†æ
perf record -e block:* -a sleep 10
perf report

# ç½‘ç»œæ ˆæ€§èƒ½
perf record -e net:* -a sleep 10
perf report
```

### å†…æ ¸å‚æ•°ä¼˜åŒ–
```bash
# /etc/sysctl.d/99-kernel-tuning.conf
# è™šæ‹Ÿå†…å­˜ç®¡ç†
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# ç½‘ç»œæ ˆè°ƒä¼˜
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# è¿›ç¨‹è°ƒåº¦
kernel.sched_migration_cost_ns = 5000000
kernel.sched_autogroup_enabled = 0

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 1000000
fs.inotify.max_user_watches = 524288

# åº”ç”¨è®¾ç½®
sysctl -p /etc/sysctl.d/99-kernel-tuning.conf
```

## ğŸ” å†…æ ¸è°ƒè¯•æŠ€æœ¯

### å†…æ ¸å´©æºƒåˆ†æ
```bash
# å®‰è£…è°ƒè¯•å·¥å…·
apt install crash linux-crashdump  # Ubuntu
dnf install crash kexec-tools       # Fedora

# é…ç½®å†…æ ¸è½¬å‚¨
echo 'kernel.panic_on_oops = 1' >> /etc/sysctl.conf
echo 'kernel.panic = 10' >> /etc/sysctl.conf

# åˆ†æå´©æºƒè½¬å‚¨
crash /usr/lib/debug/boot/vmlinux-$(uname -r) /var/crash/*/vmcore

# crashå‘½ä»¤ç¤ºä¾‹
(crash) bt      # æ˜¾ç¤ºè°ƒç”¨æ ˆ
(crash) log     # æ˜¾ç¤ºå†…æ ¸æ—¥å¿—
(crash) ps      # æ˜¾ç¤ºè¿›ç¨‹åˆ—è¡¨
(crash) files   # æ˜¾ç¤ºæ‰“å¼€çš„æ–‡ä»¶
```

### eBPFç¨‹åºå¼€å‘
```c
// hello_ebpf.c - ç®€å•çš„eBPFç¨‹åº
#include <linux/bpf.h>
#include <bpf/bpf_helpers.h>

SEC("tracepoint/syscalls/sys_enter_openat")
int trace_openat(struct trace_event_raw_sys_enter *ctx)
{
    char msg[] = "openat syscall called\n";
    bpf_trace_printk(msg, sizeof(msg));
    return 0;
}

char _license[] SEC("license") = "GPL";
```

```bash
# ç¼–è¯‘å’ŒåŠ è½½eBPFç¨‹åº
clang -O2 -target bpf -c hello_ebpf.c -o hello_ebpf.o
bpftool prog load hello_ebpf.o /sys/fs/bpf/hello_ebpf

# æŸ¥çœ‹è¾“å‡º
cat /sys/kernel/debug/tracing/trace_pipe
```

## ğŸ“š å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Linuxå†…æ ¸æ–‡æ¡£](https://www.kernel.org/doc/html/latest/)
- [å†…æ ¸APIå‚è€ƒ](https://www.kernel.org/doc/htmldocs/)
- [Linuxè®¾å¤‡é©±åŠ¨](https://lwn.net/Kernel/LDD3/)

### é‡è¦ä¹¦ç±
- **ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹** - Robert Love
- **ã€Šæ·±å…¥ç†è§£Linuxå†…æ ¸ã€‹** - Daniel Bovet & Marco Cesati
- **ã€ŠLinuxè®¾å¤‡é©±åŠ¨ç¨‹åºã€‹** - Jonathan Corbetç­‰
- **ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹** - èµµç‚¯

### åœ¨çº¿èµ„æº
- [Linux Weekly News](https://lwn.net/) - å†…æ ¸å¼€å‘æ–°é—»
- [Kernel Newbies](https://kernelnewbies.org/) - å†…æ ¸å­¦ä¹ èµ„æº
- [Linux Foundation Training](https://training.linuxfoundation.org/)

## ğŸš€ è¿›é˜¶å‘å±•

### æŠ€èƒ½å‘å±•è·¯å¾„
```mermaid
graph TB
    A[å†…æ ¸åŸºç¡€] --> B[æ¨¡å—å¼€å‘]
    B --> C[é©±åŠ¨å¼€å‘]
    C --> D[å­ç³»ç»Ÿå¼€å‘]
    D --> E[å†…æ ¸ç»´æŠ¤è€…]
    
    A --> A1[ç³»ç»Ÿè°ƒç”¨<br/>å†…å­˜ç®¡ç†<br/>è¿›ç¨‹è°ƒåº¦]
    B --> B1[LKMæœºåˆ¶<br/>å‚æ•°ä¼ é€’<br/>è°ƒè¯•æŠ€æœ¯]
    C --> C1[è®¾å¤‡é©±åŠ¨<br/>ä¸­æ–­å¤„ç†<br/>DMAæ“ä½œ]
    D --> D1[æ–‡ä»¶ç³»ç»Ÿ<br/>ç½‘ç»œåè®®æ ˆ<br/>è™šæ‹ŸåŒ–]
    E --> E1[ä»£ç å®¡æŸ¥<br/>æ€§èƒ½ä¼˜åŒ–<br/>ç¤¾åŒºè´¡çŒ®]
```

### ä¸“ä¸šè®¤è¯
- **Linuxå†…æ ¸å¼€å‘è®¤è¯** - Linux Foundation
- **åµŒå…¥å¼Linuxè®¤è¯** - CELFè®¤è¯
- **è®¾å¤‡é©±åŠ¨å¼€å‘è®¤è¯** - å‚å•†ç‰¹å®šè®¤è¯

---

*æ·±å…¥æ¢ç´¢Linuxå†…æ ¸ä¸–ç•Œï¼š[å†…æ ¸æ¶æ„](kernel-architecture.md)*
